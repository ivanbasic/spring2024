# Version 0.0.56 - Username-Based Employee Filtering

## Overview
Link employees to users via `username` instead of `employee_id`. Simpler than Lesson 055.

## Database Changes

**schema-db2.sql:**
```sql
CREATE TABLE schema2.employees (
    employee_id NUMERIC(6),
    first_name VARCHAR(20),
    hire_date TIMESTAMP,
    department_id NUMERIC(4),
    username VARCHAR(50)  -- NEW: Links to DB3.users.username
);
```

**data-db2.sql:**
```sql
-- Only ada is linked to a user
INSERT INTO schema2.employees (employee_id, first_name, hire_date, department_id, username)
VALUES (1, 'Ada', '2015-11-21 14:30:15', 1, 'ada');

INSERT INTO schema2.employees (employee_id, first_name, hire_date, department_id, username)
VALUES (2, 'Niklaus', '2016-11-21 14:30:15', 1, NULL);

INSERT INTO schema2.employees (employee_id, first_name, hire_date, department_id, username)
VALUES (3, 'Karl', '2016-11-21 14:30:15', 2, NULL);
```

**data-db3.sql:**
```sql
-- Add ada user (password: ada-ada)
INSERT INTO users (username, password, enabled)
VALUES ('ada', '{noop}ada-ada', true);

INSERT INTO authorities (username, authority)
VALUES ('ada', 'read');
```

## Service Logic

```java
public List<Employee> getMyTeam(Authentication auth) {
    // ADMIN sees all
    if (auth.getAuthorities().contains(new SimpleGrantedAuthority("SCOPE_ADMIN"))) {
        return employeeRepo.findAll();
    }
    
    // Direct lookup by username
    Employee employee = employeeRepo.findByUsername(auth.getName());
    
    if (employee == null || employee.getDepartment() == null) {
        return Collections.emptyList();
    }
    
    return employeeRepo.findByDepartmentDepartmentId(
        employee.getDepartment().getDepartmentId()
    );
}
```

## Comparison: Lesson 055 vs 056

| Aspect | Lesson 055 (employee_id) | Lesson 056 (username) |
|--------|--------------------------|------------------------|
| **Link** | DB3.users.employee_id → DB2.employees.employee_id | DB3.users.username → DB2.employees.username |
| **Custom Security** | ✅ Required (EmployeeLinkedUserDetails) | ❌ Not needed |
| **Service Complexity** | High (load user, extract ID, lookup) | Low (direct username lookup) |
| **Code Lines** | ~60 | ~20 |

## Why This is Simpler

1. **No custom security classes** - standard Spring Security works
2. **Direct lookup** - `auth.getName()` gives username immediately
3. **Less code** - 3x shorter service method
4. **Works with JWT and Basic Auth** - no special handling needed

## Testing

**Endpoint:** `GET /db2/employees/my-team`

**Expected Results:**

| User | Has username in DB2? | Department | Sees |
|------|---------------------|------------|------|
| ivan | ❌ No | - | All 3 employees (ADMIN) |
| ada | ✅ Yes | IT (dept 1) | Ada, Niklaus (dept 1) |
| karl | ❌ No | - | Empty list (not linked) |
| bcryptuser | ❌ No | - | Empty list (not an employee) |

## Files Modified

- schema-db2.sql - added username column
- data-db2.sql - added username for ada only
- data-db3.sql - added ada user
- Employee.java - added username field + getters
- Department.java - added getters
- EmployeeRepo.java - added query methods
- EmployeeService.java
- EmployeeServiceImpl.java
- EmployeeController.java
- pom.xml
- CHANGELOG.md

---

**Key Takeaway:** When you control the database schema, linking by username is simpler than creating custom security classes.