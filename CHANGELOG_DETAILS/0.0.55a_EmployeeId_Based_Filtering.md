# Version 0.0.55 - EmployeeId-Based Employee Filtering (Not Merged)

## Overview
Link users to employees via `employee_id` field in DB3 users table. Requires custom security classes.

## Database Changes

**schema-db3.sql:**
```sql
CREATE TABLE users (
    username VARCHAR(50) NOT NULL PRIMARY KEY,
    password VARCHAR(500) NOT NULL,
    enabled BOOLEAN NOT NULL,
    employee_id INT NULL  -- NEW: Links to DB2.employees.employee_id
);
```

**data-db3.sql:**
```sql
-- Manager users linked to employees
INSERT INTO users (username, password, enabled, employee_id) 
VALUES ('ada', '{noop}ada', true, 1);

INSERT INTO users (username, password, enabled, employee_id) 
VALUES ('karl', '{noop}karl', true, 2);

INSERT INTO authorities (username, authority) 
VALUES ('ada', 'ROLE_MANAGER'), ('karl', 'ROLE_MANAGER');
```

## Custom Security Classes

**EmployeeLinkedUserDetails:**
```java
public class EmployeeLinkedUserDetails extends User {
    private final Integer employeeId;
    
    public EmployeeLinkedUserDetails(String username, String password, 
                                     boolean enabled, boolean accountNonExpired,
                                     boolean credentialsNonExpired, 
                                     boolean accountNonLocked,
                                     Collection<? extends GrantedAuthority> authorities,
                                     Integer employeeId) {
        super(username, password, enabled, accountNonExpired, 
              credentialsNonExpired, accountNonLocked, authorities);
        this.employeeId = employeeId;
    }
    
    public Integer getEmployeeId() {
        return employeeId;
    }
}
```

**EmployeeLinkedUserDetailsManager:**
```java
public class EmployeeLinkedUserDetailsManager extends JdbcUserDetailsManager {
    
    public EmployeeLinkedUserDetailsManager(DataSource dataSource) {
        super(dataSource);
        setUsersByUsernameQuery(
            "SELECT username, password, enabled, employee_id FROM users WHERE username = ?"
        );
    }

    @Override
    public UserDetails loadUserByUsername(String username) {
        List<UserDetails> users = loadUsersByUsername(username);
        if (users.isEmpty()) {
            throw new UsernameNotFoundException("User not found");
        }
        return users.get(0);
    }

    @Override
    protected List<UserDetails> loadUsersByUsername(String username) {
        return getJdbcTemplate().query(
            getUsersByUsernameQuery(),
            new String[]{username},
            new EmployeeLinkedUserDetailsRowMapper()
        );
    }

    private class EmployeeLinkedUserDetailsRowMapper implements RowMapper<UserDetails> {
        @Override
        public UserDetails mapRow(ResultSet rs, int rowNum) throws SQLException {
            String username = rs.getString(1);
            String password = rs.getString(2);
            boolean enabled = rs.getBoolean(3);
            Integer employeeId = (Integer) rs.getObject(4);
            
            List<GrantedAuthority> authorities = loadUserAuthorities(username);
            
            return new EmployeeLinkedUserDetails(
                username, password, enabled, true, true, true, 
                authorities, employeeId
            );
        }
    }
}
```

## Service Logic

```java
public List<Employee> getEmployeesForManager(Authentication auth) {
    // ADMIN sees all
    if (auth.getAuthorities().contains(new SimpleGrantedAuthority("SCOPE_ADMIN"))) {
        return employeeRepo.findAll();
    }
    
    // Load CustomUserDetails with employee_id
    String username = auth.getName();
    EmployeeLinkedUserDetails user = 
        (EmployeeLinkedUserDetails) userDetailsService.loadUserByUsername(username);
    
    if (user.getEmployeeId() == null) {
        return Collections.emptyList();
    }
    
    // Find employee by employee_id, then filter by department
    Employee manager = employeeRepo.findByEmployeeId(user.getEmployeeId());
    if (manager == null || manager.getDepartment() == null) {
        return Collections.emptyList();
    }
    
    return employeeRepo.findByDepartmentDepartmentId(
        manager.getDepartment().getDepartmentId()
    );
}
```

## Comparison: Version 055 vs 056

| Aspect | Version 055 (employee_id) | Version 056 (username) |
|--------|---------------------------|------------------------|
| **Link Location** | DB3.users.employee_id → DB2.employees.employee_id | DB3.users.username → DB2.employees.username |
| **Custom Security Classes** | ✅ Required | ❌ Not needed |
| **Security Classes** | EmployeeLinkedUserDetails + EmployeeLinkedUserDetailsManager | Standard Spring Security |
| **Complexity** | High - custom UserDetails loading | Low - direct lookup |
| **Service Method** | ~50 lines (load user, extract ID, lookup employee) | ~20 lines (direct username lookup) |

## Why This Was More Complex

1. **Custom security classes required** - Must extend UserDetails and JdbcUserDetailsManager
2. **Multi-step lookup** - Load user → extract employee_id → find employee → get department
3. **JWT handling** - Must handle both JWT and Basic Auth principals differently
4. **More code** - Additional classes and complex service logic

## Why Version 056 Is Better

Version 056 (username-based) is simpler because:
- No custom security classes needed
- Direct lookup by username (one step instead of three)
- Works naturally with Spring Security's `auth.getName()`
- Less code to maintain

## Files Created/Modified (Version 055)

**Created:**
- EmployeeLinkedUserDetails.java
- EmployeeLinkedUserDetailsManager.java

**Modified:**
- schema-db3.sql - added employee_id column
- data-db3.sql - added ada & karl users
- SecurityConfig.java - uses EmployeeLinkedUserDetailsManager
- Employee.java - added getters
- Department.java - added getters
- EmployeeRepo.java - added findByEmployeeId() and findByDepartmentDepartmentId()
- EmployeeService.java
- EmployeeServiceImpl.java
- EmployeeController.java

---

**Conclusion:** Version 055 demonstrates proper extension of Spring Security classes, but Version 056 shows that simpler solutions exist when you control the database schema.

**Status:** This version was NOT merged to main. Version 056 was chosen instead for its simplicity.